name: React Vite ‚Üí IIS (Auto-Create Site + Backup + Rollback)

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Manual trigger

jobs:
  deploy-with-approval:
    runs-on: self-hosted  # Your Windows server runner [cite:1]

    steps:
    # 1. CHECK IIS SITE & CREATE IF MISSING + BACKUP
    - name: Check/Create IIS Site & Backup
      shell: powershell
      run: |
        Import-Module WebAdministration

        $siteName = "MyReactApp"
        $deployPath = "C:\inetpub\wwwroot\MyReactApp"
        $appPoolName = "MyReactAppPool"
        $backupPath = "C:\inetpub\wwwroot\backups\MyReactApp_backup_$(Get-Date -Format 'yyyyMMdd_HHmmss')"

        # Create backup directory
        New-Item -ItemType Directory -Force -Path "C:\inetpub\wwwroot\backups"

        # CHECK IF SITE EXISTS
        if (Get-Website -Name $siteName -ErrorAction SilentlyContinue) {
          Write-Output "‚úÖ Site '$siteName' exists. Checking app content..."

          # Backup existing app
          if (Test-Path $deployPath) {
            Copy-Item $deployPath $backupPath -Recurse -Force
            Write-Output "‚úÖ Backup created: $backupPath"
            echo "BACKUP_PATH=$backupPath" >> $env:GITHUB_ENV
            echo "SITE_EXISTS=true" >> $env:GITHUB_ENV
          } else {
            echo "BACKUP_PATH=" >> $env:GITHUB_ENV
            echo "SITE_EXISTS=true" >> $env:GITHUB_ENV
          }
        } else {
          Write-Output "‚ÑπÔ∏è Site '$siteName' NOT found. Creating new site..."

          # CREATE APP POOL
          if (-not (Get-WebAppPoolState -Name $appPoolName -ErrorAction SilentlyContinue)) {
            New-WebAppPool -Name $appPoolName
            Set-ItemProperty "IIS:\AppPools\$appPoolName" -Name processModel.identityType -Value SpecificUser
            Set-ItemProperty "IIS:\AppPools\$appPoolName" -Name processModel.userName -Value "IIS APPPOOL\$appPoolName"
            Write-Output "‚úÖ App Pool '$appPoolName' created"
          }

          # CREATE PHYSICAL PATH
          New-Item -ItemType Directory -Force -Path $deployPath

          # CREATE WEBSITE
          New-Website -Name $siteName -Port 8080 -PhysicalPath $deployPath -ApplicationPool $appPoolName
          Write-Output "‚úÖ Site '$siteName' created on port 8080"

          echo "SITE_EXISTS=false" >> $env:GITHUB_ENV
          echo "BACKUP_PATH=" >> $env:GITHUB_ENV
        }

    # 2. CHECKOUT & BUILD
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install & Build
      run: |
        npm ci
        npm run build
      shell: cmd

    # 3. MANUAL APPROVAL
    - name: Wait for Deployment Approval
      uses: trstringer/manual-approval@v1
      with:
        secret: ${{ github.TOKEN }}
        approvers: sharath  # Replace with YOUR username
        minimum-approvals: 1
        issue-title: "üöÄ Deploy React App to IIS"
        issue-body: |
          **Ready to deploy React Vite app**

          **Site Status:** ${{ env.SITE_EXISTS == 'true' && '‚úÖ Exists (backed up)' || 'üÜï Created new' }}
          **Backup:** `${{ env.BACKUP_PATH || 'None (new site)' }}`
          **New build ready:** `./dist`
          **Target:** `http://localhost:8080`

          üëÜ Click **APPROVE** to deploy

    # 4. DEPLOY NEW VERSION
    - name: Deploy New App
      shell: powershell
      run: |
        Import-Module WebAdministration

        $siteName = "MyReactApp"
        $deployPath = "C:\inetpub\wwwroot\MyReactApp"
        $appPoolName = "MyReactAppPool"
        $buildPath = "$PWD\dist"

        Write-Output "üöÄ Deploying to $deployPath"

        # Stop app pool
        Stop-WebAppPool -Name $appPoolName

        # Deploy new files (with web.config for React routing)
        Remove-Item $deployPath\* -Recurse -Force -ErrorAction SilentlyContinue
        Copy-Item $buildPath\* $deployPath -Recurse -Force

        # Create web.config for React SPA routing
        $webConfig = @"
<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <system.webServer>
    <rewrite>
      <rules>
        <rule name="React Routes" stopProcessing="true">
          <match url=".*" />
          <conditions logicalGrouping="MatchAll">
            <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
            <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
            <add input="{REQUEST_URI}" pattern="^/(api)" negate="true" />
          </conditions>
          <action type="Rewrite" url="index.html" />
        </rule>
      </rules>
    </rewrite>
    <staticContent>
      <mimeMap fileExtension=".json" mimeType="application/json" />
    </staticContent>
  </system.webServer>
</configuration>
"@
        $webConfig | Out-File "$deployPath\web.config" -Encoding UTF8

        # Start app pool
        Start-WebAppPool -Name $appPoolName

        Write-Output "‚úÖ Deployed to http://localhost:8080"

    # 5. HEALTH CHECK & AUTO ROLLBACK
    - name: Verify & Rollback if Failed
      shell: powershell
      run: |
        Import-Module WebAdministration

        $siteName = "MyReactApp"
        $deployPath = "C:\inetpub\wwwroot\MyReactApp"
        $backupPath = "${{ env.BACKUP_PATH }}"
        $appPoolName = "MyReactAppPool"
        $siteUrl = "http://localhost:8080"

        Write-Output "üîç Health check: $siteUrl"

        Start-Sleep -Seconds 3  # Wait for IIS

        # Test 1: Files exist
        if (-not (Test-Path "$deployPath\index.html")) {
          throw "‚ùå index.html missing"
        }

        # Test 2: HTTP 200
        try {
          $response = Invoke-WebRequest -Uri $siteUrl -TimeoutSec 20 -UseBasicParsing -MaximumRedirection 0
          if ($response.StatusCode -ne 200) {
            throw "HTTP ${response.StatusCode}"
          }
          Write-Output "‚úÖ Deployment successful! HTTP 200 OK"
        }
        catch {
          Write-Output "‚ùå Health check failed: $_"

          if ($backupPath -and (Test-Path $backupPath)) {
            Write-Output "üîÑ ROLLING BACK..."

            Stop-WebAppPool -Name $appPoolName
            Remove-Item $deployPath\* -Recurse -Force
            Copy-Item $backupPath\* $deployPath -Recurse -Force
            Start-WebAppPool -Name $appPoolName

            Write-Output "‚úÖ Rolled back to: $backupPath"
          }
          exit 1
        }

 
