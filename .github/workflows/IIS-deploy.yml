name: React Vite ‚Üí IIS (Auto-Create Site + Backup + Rollback)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

# Needed for the manual approval action to create an issue
permissions:
  contents: read
  issues: write

# Optional: prevent overlapping deploys to the same target
concurrency:
  group: react-vite-iis-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy-with-approval:
    # Match your self-hosted runner labels exactly as registered
    runs-on: [self-hosted, windows, X64]

    steps:
      # 1) CHECK IIS SITE & CREATE IF MISSING + BACKUP
      - name: Check/Create IIS Site & Backup
        shell: powershell
        run: |
          Import-Module WebAdministration

          $siteName    = "MyReactApp"
          $deployPath  = "C:\inetpub\wwwroot\MyReactApp"
          $appPoolName = "MyReactAppPool"
          $backupRoot  = "C:\inetpub\wwwroot\backups"
          New-Item -ItemType Directory -Force -Path $backupRoot | Out-Null

          if (Get-Website -Name $siteName -ErrorAction SilentlyContinue) {
            Write-Output "‚úÖ Site '$siteName' exists"

            if (Test-Path $deployPath) {
              $timestamp  = Get-Date -Format 'yyyyMMdd_HHmmss'
              $backupPath = Join-Path $backupRoot "MyReactApp_backup_$timestamp"
              Copy-Item $deployPath $backupPath -Recurse -Force
              Write-Output "‚úÖ Backup: $backupPath"
              Add-Content -Path $env:GITHUB_ENV -Value "BACKUP_PATH=$backupPath"
            }

            Add-Content -Path $env:GITHUB_ENV -Value "SITE_EXISTS=true"
          }
          else {
            Write-Output "üÜï Creating site '$siteName'..."
            if (-not (Get-WebAppPoolState -Name $appPoolName -ErrorAction SilentlyContinue)) {
              New-WebAppPool -Name $appPoolName | Out-Null
              Write-Output "‚úÖ App Pool created"
            }
            New-Item -ItemType Directory -Force -Path $deployPath | Out-Null
            New-Website -Name $siteName -Port 8080 -PhysicalPath $deployPath -ApplicationPool $appPoolName | Out-Null
            Write-Output "‚úÖ Site created on port 8080"

            Add-Content -Path $env:GITHUB_ENV -Value "SITE_EXISTS=false"
          }

      # 2) CHECKOUT & BUILD
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install & Build
        shell: cmd
        run: |
          npm ci
          npm run build

      # 3) MANUAL APPROVAL
      - name: Wait for Deployment Approval
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ secrets.GITHUB_TOKEN }}   # ‚úÖ use the built-in token
          approvers: sharath                   # <-- put your actual GitHub username here
          minimum-approvals: 1
          issue-title: "üöÄ Deploy React App to IIS"
          issue-body: |
            **Ready to deploy React Vite app**

            **Target:** http://localhost:8080
            **Backup created automatically**

            üëÜ Click **APPROVE** to deploy

      # 4) DEPLOY
      - name: Deploy New App
        shell: powershell
        run: |
          Import-Module WebAdministration

          $siteName    = "MyReactApp"
          $deployPath  = "C:\inetpub\wwwroot\MyReactApp"
          $appPoolName = "MyReactAppPool"

          $buildPath = Join-Path $PWD.Path 'dist'
          if (-not (Test-Path $buildPath)) {
            throw "‚ùå Build output not found at $buildPath"
          }

          # Stop pool, replace content, write SPA rewrite config
          Stop-WebAppPool -Name $appPoolName -ErrorAction SilentlyContinue
          if (Test-Path $deployPath) {
            Remove-Item (Join-Path $deployPath '*') -Recurse -Force -ErrorAction SilentlyContinue
          } else {
            New-Item -ItemType Directory -Force -Path $deployPath | Out-Null
          }
          Copy-Item (Join-Path $buildPath '*') $deployPath -Recurse -Force

          $webConfigPath = Join-Path $deployPath 'web.config'
          if (Test-Path $webConfigPath) {
            Remove-Item $webConfigPath -Force -ErrorAction SilentlyContinue
          }

          @'
<?xml version="1.0"?>
<configuration>
  <system.webServer>
    <rewrite>
      <rules>
        <rule name="React Routes" stopProcessing="true">
          <match url=".*" />
          <conditions logicalGrouping="MatchAll">
            <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
          </conditions>
          <action type="Rewrite" url="index.html" />
        </rule>
      </rules>
    </rewrite>
  </system.webServer>
</configuration>
'@ | Set-Content -Path $webConfigPath -Encoding UTF8

          Start-WebAppPool -Name $appPoolName
          Write-Output "‚úÖ Deployed!"

      # 5) HEALTH CHECK
      - name: Verify Deployment
        shell: powershell
        run: |
          $deployPath = "C:\inetpub\wwwroot\MyReactApp"
          $backupPath = "${{ env.BACKUP_PATH }}"
          $siteUrl    = "http://localhost:8080"

          Start-Sleep -Seconds 3

          if (-not (Test-Path (Join-Path $deployPath 'index.html'))) {
            throw "‚ùå index.html missing"
          }

          try {
            $response = Invoke-WebRequest -Uri $siteUrl -TimeoutSec 20 -UseBasicParsing
          } catch {
            throw "‚ùå Health check failed: $($_.Exception.Message)"
          }

          if ($response.StatusCode -ne 200) {
            throw "‚ùå HTTP $($response.StatusCode)"
          }

          Write-Output "‚úÖ SUCCESS! $siteUrl is live"
``