name: React Vite ‚Üí IIS (Auto-Create Site + Backup + Rollback)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy-with-approval:
    runs-on: self-hosted

    steps:
    # 1. CHECK IIS SITE & CREATE IF MISSING + BACKUP
    - name: Check/Create IIS Site & Backup
      shell: powershell
      run: |
        Import-Module WebAdministration

        $siteName = "MyReactApp"
        $deployPath = "C:\inetpub\wwwroot\MyReactApp"
        $appPoolName = "MyReactAppPool"
        $backupPath = "C:\inetpub\wwwroot\backups\MyReactApp_backup_$(Get-Date -Format 'yyyyMMdd_HHmmss')"

        New-Item -ItemType Directory -Force -Path "C:\inetpub\wwwroot\backups"

        if (Get-Website -Name $siteName -ErrorAction SilentlyContinue) {
          Write-Output "‚úÖ Site '$siteName' exists"
          if (Test-Path $deployPath) {
            Copy-Item $deployPath $backupPath -Recurse -Force
            Write-Output "‚úÖ Backup: $backupPath"
            echo "BACKUP_PATH=$backupPath" >> $env:GITHUB_ENV
          }
          echo "SITE_EXISTS=true" >> $env:GITHUB_ENV
        } else {
          Write-Output "üÜï Creating site '$siteName'..."
          if (-not (Get-WebAppPoolState -Name $appPoolName -ErrorAction SilentlyContinue)) {
            New-WebAppPool -Name $appPoolName
            Write-Output "‚úÖ App Pool created"
          }
          New-Item -ItemType Directory -Force -Path $deployPath
          New-Website -Name $siteName -Port 8080 -PhysicalPath $deployPath -ApplicationPool $appPoolName
          Write-Output "‚úÖ Site created on port 8080"
          echo "SITE_EXISTS=false" >> $env:GITHUB_ENV
        }

    # 2. CHECKOUT & BUILD
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install & Build
      run: |
        npm ci
        npm run build
      shell: cmd

    # 3. MANUAL APPROVAL - FIXED ‚úÖ
    - name: Wait for Deployment Approval
      uses: trstringer/manual-approval@v1
      with:
        secret: ${{ github.TOKEN }}
        approvers: sharath
        minimum-approvals: 1
        issue-title: "üöÄ Deploy React App to IIS"
        issue-body: |
          **Ready to deploy React Vite app**

          **Target:** http://localhost:8080
          **Backup created automatically**

          üëÜ Click **APPROVE** to deploy

    # 4. DEPLOY
    - name: Deploy New App
      shell: powershell
      run: |
        Import-Module WebAdministration
        $siteName = "MyReactApp"
        $deployPath = "C:\inetpub\wwwroot\MyReactApp"
        $appPoolName = "MyReactAppPool"
        $buildPath = "$PWD\dist"

        Stop-WebAppPool -Name $appPoolName
        Remove-Item $deployPath\* -Recurse -Force -ErrorAction SilentlyContinue
        Copy-Item $buildPath\* $deployPath -Recurse -Force

        $webConfigPath = "$deployPath\web.config"
        Remove-Item $webConfigPath -ErrorAction SilentlyContinue
        Add-Content -Path $webConfigPath -Value '<?xml version="1.0"?>'
        Add-Content -Path $webConfigPath -Value '<configuration>'
        Add-Content -Path $webConfigPath -Value '  <system.webServer>'
        Add-Content -Path $webConfigPath -Value '    <rewrite>'
        Add-Content -Path $webConfigPath -Value '      <rules>'
        Add-Content -Path $webConfigPath -Value '        <rule name="React Routes" stopProcessing="true">'
        Add-Content -Path $webConfigPath -Value '          <match url=".*" />'
        Add-Content -Path $webConfigPath -Value '          <conditions logicalGrouping="MatchAll">'
        Add-Content -Path $webConfigPath -Value '            <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />'
        Add-Content -Path $webConfigPath -Value '          </conditions>'
        Add-Content -Path $webConfigPath -Value '          <action type="Rewrite" url="index.html" />'
        Add-Content -Path $webConfigPath -Value '        </rule>'
        Add-Content -Path $webConfigPath -Value '      </rules>'
        Add-Content -Path $webConfigPath -Value '    </rewrite>'
        Add-Content -Path $webConfigPath -Value '  </system.webServer>'
        Add-Content -Path $webConfigPath -Value '</configuration>'
        Start-WebAppPool -Name $appPoolName
        Write-Output "‚úÖ Deployed!"


    # 5. HEALTH CHECK
    - name: Verify Deployment
      shell: powershell
      run: |
        $deployPath = "C:\inetpub\wwwroot\MyReactApp"
        $backupPath = "${{ env.BACKUP_PATH }}"
        $siteUrl = "http://localhost:8080"

        Start-Sleep -Seconds 3

        if (-not (Test-Path "$deployPath\index.html")) {
          throw "‚ùå index.html missing"
        }

        $response = Invoke-WebRequest -Uri $siteUrl -TimeoutSec 20 -UseBasicParsing
        if ($response.StatusCode -ne 200) { throw "HTTP $($response.StatusCode)" }

        Write-Output "‚úÖ SUCCESS! http://localhost:8080 is live"

 