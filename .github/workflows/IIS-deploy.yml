name: React Vite to IIS (Production Safe + Rollback)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted

    steps:

    # ==========================================================
    # 1️⃣ CHECK / CREATE IIS SITE + BACKUP
    # ==========================================================
    - name: Prepare IIS + Backup
      shell: powershell
      run: |
        Import-Module WebAdministration

        $siteName = "MyReactApp"
        $deployPath = "C:\inetpub\wwwroot\MyReactApp"
        $appPoolName = "MyReactAppPool"
        $backupRoot = "C:\inetpub\wwwroot\backups"
        $backupPath = "$backupRoot\MyReactApp_$(Get-Date -Format 'yyyyMMddHHmmss')"

        # Ensure backup folder exists
        if (!(Test-Path $backupRoot)) {
          New-Item -ItemType Directory -Path $backupRoot -Force
        }

        # Ensure deploy folder exists
        if (!(Test-Path $deployPath)) {
          New-Item -ItemType Directory -Path $deployPath -Force
        }

        # Check if IIS site exists
        if (Get-Website -Name $siteName -ErrorAction SilentlyContinue) {
          Write-Output "Site exists"

          if (Test-Path "$deployPath\*") {
            Copy-Item $deployPath $backupPath -Recurse -Force
            Write-Output "Backup created at $backupPath"
            echo "BACKUP_PATH=$backupPath" >> $env:GITHUB_ENV
          }

        } else {
          Write-Output "Creating IIS Site"

          # Create AppPool if missing
          if (!(Get-ChildItem IIS:\AppPools | Where-Object {$_.Name -eq $appPoolName})) {
            New-WebAppPool -Name $appPoolName
          }

          New-Website -Name $siteName `
                      -Port 8080 `
                      -PhysicalPath $deployPath `
                      -ApplicationPool $appPoolName
        }

    # ==========================================================
    # 2️⃣ CHECKOUT & BUILD
    # ==========================================================
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install Dependencies
      run: npm ci
      shell: cmd

    - name: Build Project
      run: npm run build
      shell: cmd

    - name: Verify Build Output
      shell: powershell
      run: |
        if (!(Test-Path "$PWD\dist")) {
          throw "Build failed - dist folder not found"
        }

    # ==========================================================
    # 3️⃣ DEPLOY SAFELY (NO IIS RACE CONDITION)
    # ==========================================================
    - name: Deploy Application
      shell: powershell
      run: |
        Import-Module WebAdministration

        $deployPath = "C:\inetpub\wwwroot\MyReactApp"
        $appPoolName = "MyReactAppPool"
        $buildPath = "$PWD\dist"

        # Ensure IIS Service running
        $svc = Get-Service W3SVC
        if ($svc.Status -ne "Running") {
          Start-Service W3SVC
          Start-Sleep -Seconds 5
        }

        # Stop AppPool safely
        $state = (Get-WebAppPoolState -Name $appPoolName).Value
        if ($state -ne "Stopped") {
          Stop-WebAppPool -Name $appPoolName

          do {
            Start-Sleep -Seconds 2
            $state = (Get-WebAppPoolState -Name $appPoolName).Value
          } while ($state -ne "Stopped")
        }

        # Clean old files
        Remove-Item "$deployPath\*" -Recurse -Force -ErrorAction SilentlyContinue

        # Copy new build
        Copy-Item "$buildPath\*" $deployPath -Recurse -Force

        # Create web.config for React Routing
        $webConfig = @"
<?xml version="1.0"?>
<configuration>
  <system.webServer>
    <rewrite>
      <rules>
        <rule name="React Routes" stopProcessing="true">
          <match url=".*" />
          <conditions logicalGrouping="MatchAll">
            <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
          </conditions>
          <action type="Rewrite" url="index.html" />
        </rule>
      </rules>
    </rewrite>
  </system.webServer>
</configuration>
"@

        Set-Content "$deployPath\web.config" $webConfig -Encoding UTF8

        # Start AppPool safely
        Start-Sleep -Seconds 3
        Start-WebAppPool -Name $appPoolName

        do {
          Start-Sleep -Seconds 2
          $state = (Get-WebAppPoolState -Name $appPoolName).Value
        } while ($state -ne "Started")

        Write-Output "Deployment completed"

    # ==========================================================
    # 4️⃣ HEALTH CHECK
    # ==========================================================
    - name: Health Check
      shell: powershell
      run: |
        Start-Sleep -Seconds 5
        $response = Invoke-WebRequest -Uri "http://localhost:8080" -TimeoutSec 20 -UseBasicParsing

        if ($response.StatusCode -ne 200) {
          throw "Health check failed with status $($response.StatusCode)"
        }

        Write-Output "Application is LIVE"

    # ==========================================================
    # 5️⃣ AUTO ROLLBACK IF FAILED
    # ==========================================================
    - name: Rollback On Failure
      if: failure()
      shell: powershell
      run: |
        Import-Module WebAdministration

        if ($env:BACKUP_PATH -and (Test-Path $env:BACKUP_PATH)) {

          Write-Output "Rolling back..."

          $deployPath = "C:\inetpub\wwwroot\MyReactApp"
          $appPoolName = "MyReactAppPool"

          Stop-WebAppPool -Name $appPoolName
          Remove-Item "$deployPath\*" -Recurse -Force -ErrorAction SilentlyContinue
          Copy-Item "$env:BACKUP_PATH\*" $deployPath -Recurse -Force
          Start-WebAppPool -Name $appPoolName

          Write-Output "Rollback completed"
        }
